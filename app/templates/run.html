{% extends "base.html" %}
{% block content %}
<div class="container mt-4 d-flex justify-content-center">
  <div class="card shadow-lg w-75 text-center">
    <div class="card-body">

      <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–ª–µ—à-—Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ base.html –Ω–µ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ) -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3">
            {% for category, msg in messages %}
              <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ msg }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
      {% if word.image_url %}
        <div class="mb-4 d-flex justify-content-center">
          <img src="{{ word.image_url }}" alt="image"
               class="img-fluid rounded shadow-sm mx-auto d-block"
               style="max-height: 250px; object-fit: contain;">
        </div>
      {% endif %}

      <!-- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ -->
      <p class="fs-5"><strong>Definition:</strong> {{ word.definition }}</p>

      <!-- –í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ -->
      <form method="post" action="{{ url_for('tests_bp.check_answer', index=current_index) }}">
        <div id="answer-fields" class="d-flex justify-content-center mb-3 flex-wrap"></div>
        <button type="submit" class="btn btn-success">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        <div class="mt-2 text-muted small">üí° –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞</div>
      </form>

      <div class="mt-3 text-muted">–°–ª–æ–≤–æ {{ current_index+1 }} –∏–∑ {{ total }}</div>

    </div>
  </div>
</div>

<script>
const wordLength = "{{ word_length | tojson }}";
const container = document.getElementById("answer-fields");

// –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º inputs
for (let i = 0; i < wordLength; i++) {
  const input = document.createElement("input");
  input.type = "text";
  input.name = "letters";
  input.maxLength = 1;
  input.className = "form-control m-1";
  input.style.width = "40px";
  input.style.textAlign = "center";
  // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—è
  input.value = "";
  container.appendChild(input);
}

// –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –ø–µ—Ä–µ—Ö–æ–¥ –≤–ø–µ—Ä–µ–¥ –ø—Ä–∏ –≤–≤–æ–¥–µ –∏ –Ω–∞–∑–∞–¥ –ø—Ä–∏ backspace
const inputs = container.querySelectorAll("input");
inputs.forEach((input, idx) => {
  input.addEventListener("input", (e) => {
    if (e.target.value.length === 1 && idx < inputs.length - 1) {
      inputs[idx + 1].focus();
    }
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && !input.value && idx > 0) {
      inputs[idx - 1].focus();
    } else if (e.key === "ArrowLeft" && idx > 0) {
      inputs[idx - 1].focus();
    } else if (e.key === "ArrowRight" && idx < inputs.length - 1) {
      inputs[idx + 1].focus();
    } else if (e.key === "Enter") {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –ª—é–±–æ–º –ø–æ–ª–µ
      e.preventDefault();
      const form = input.closest('form');
      if (form) {
        form.submit();
      }
    }
  });
});

// autofocus –Ω–∞ –ø–µ—Ä–≤—ã–π –∏–Ω–ø—É—Ç –∏ –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
  // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
  inputs.forEach(input => {
    input.value = "";
  });
  
  // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π –∏–Ω–ø—É—Ç
  if (inputs.length) {
    inputs[0].focus();
  }
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', function() {
  inputs.forEach(input => {
    input.value = "";
  });
  
  if (inputs.length) {
    inputs[0].focus();
  }
});
</script>
{% endblock %}
